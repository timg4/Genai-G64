<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wind Manual Assistant</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1720;
      --panel-2: #111b27;
      --text: #e6edf3;
      --muted: #a9b4c0;
      --border: #233042;
      --accent: #10a37f;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 50% -10%, #162237 0%, var(--bg) 55%);
      color: var(--text);
    }
    a { color: inherit; }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }
    .title {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }
    .title h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .pill {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    .grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .card-h {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.12);
    }
    .card .card-h h2 {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .card .card-b { padding: 16px; }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 6px;
    }
    textarea, select, input[type="text"], input[type="number"], input[type="datetime-local"] {
      width: 100%;
      color: var(--text);
      background: rgba(0,0,0,.20);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    textarea { min-height: 86px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .drop {
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.14);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: .15s ease;
      user-select: none;
    }
    .drop.drag {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(16,163,127,.15);
    }
    .drop b { color: var(--text); }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .chip:hover { border-color: rgba(255,255,255,.35); }

    .file-list { margin-top: 10px; display: grid; gap: 10px; }
    .file-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,.18);
    }
    .file-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .file-name { font-family: var(--mono); font-size: 12px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn-mini {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    .btn-mini:hover { border-color: rgba(255,255,255,.35); }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
    }
    .btn {
      background: var(--accent);
      border: 0;
      color: #062015;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
    }
    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }

    /* Chat area */
    .chat {
      min-height: 560px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(0,0,0,.16);
    }
    .msg .m-h {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.10);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    .msg .m-b {
      padding: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .mono { font-family: var(--mono); }

    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: var(--accent);
      border-radius: 999px;
      animation: spin 1s linear infinite;
      vertical-align: -2px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th { font-size: 12px; color: var(--muted); font-weight: 600; background: rgba(0,0,0,.10); }
    td { font-size: 13px; }
    .snippet { color: var(--muted); font-size: 12px; }
    .warn { color: var(--danger); font-size: 12px; }

    .table-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 0;
    }
    .table-controls .left { display: flex; gap: 10px; align-items: center; }
    .range { width: 220px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">
        <h1>Wind Manual Assistant</h1>
        <span class="pill">ChatGPT-like UI prototype</span>
      </div>
      <div class="small">Backend: FastAPI &nbsp;|&nbsp; Retrieval: local BM25 (swap with your vector DB)</div>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <div class="card-h"><h2>Inputs</h2><span class="pill" id="statusPill">idle</span></div>
        <div class="card-b">
          <label>Free text context</label>
          <textarea id="freeText" placeholder="e.g., underperformance in high wind, no alarms..."></textarea>

          <label>Mechanic notes (optional)</label>
          <textarea id="mechanicNotes" placeholder="e.g., customer report, recent maintenance, observed behavior..."></textarea>

          <label>Images (drag & drop). We only forward text descriptions, not pixels.</label>
          <div id="drop" class="drop">
            <b>Drop images here</b><div class="small">or click to select. You can also add pre-described samples below.</div>
            <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
          </div>

          <div class="chips" id="sampleChips"></div>
          <div class="file-list" id="fileList"></div>

          <label>SCADA window (pick a prepared time range)</label>
          <select id="scadaSelect"></select>
          <div class="small" id="scadaPreview" style="margin-top:6px;"></div>

          <div class="row">
            <div>
              <label>Retrieve top K</label>
              <input id="topK" type="number" min="3" max="30" value="10" />
              <div class="small">Returned by backend</div>
            </div>
            <div>
              <label>Show rows</label>
              <input id="showRows" type="number" min="3" max="30" value="10" />
              <div class="small">Client-side filter</div>
            </div>
          </div>

          <div class="actions">
            <button id="runBtn" class="btn">Run</button>
          </div>
          <div class="small" style="margin-top:10px;">
            Tip: The query composer tries to exclude sections like <span class="mono">change log</span>, <span class="mono">abbreviations</span>, <span class="mono">terms and definitions</span>.
          </div>
          <div class="warn" id="warnBox" style="margin-top:10px; display:none;"></div>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="card">
        <div class="card-h"><h2>Conversation</h2><span class="pill" id="modelPill">model: auto</span></div>
        <div class="card-b">
          <div class="chat" id="chat"></div>

          <div style="height: 14px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="card-h">
              <h2>Top retrieved manual chunks</h2>
              <div class="table-controls">
                <div class="left">
                  <span class="small">Show</span>
                  <input class="range" id="rangeRows" type="range" min="3" max="30" value="10" />
                  <span class="pill" id="rangeLabel">10</span>
                </div>
              </div>
            </div>
            <div class="card-b" style="padding:0;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Score</th>
                    <th>Source</th>
                    <th>Pages</th>
                    <th>Section</th>
                    <th>Snippet</th>
                  </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  const state = {
    files: [], // {name, desc}
    scadaOptions: [],
    lastResults: [],
  };

  const sampleImageDescriptions = [
    "crack near leading edge; erosion visible",
    "surface coating damage / paint peel; possible gelcoat delamination",
    "lightning receptor damage near tip; burn marks"
  ];

  function el(id){ return document.getElementById(id); }

  function setStatus(text){
    el('statusPill').textContent = text;
  }

  function showWarn(msg){
    const box = el('warnBox');
    box.style.display = msg ? 'block' : 'none';
    box.textContent = msg || '';
  }

  function addChatMessage(role, title, body){
    const chat = el('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg';
    wrap.innerHTML = `
      <div class="m-h"><span>${title}</span><span class="pill">${role}</span></div>
      <div class="m-b" id="msg_${Date.now()}">${body}</div>
    `;
    chat.prepend(wrap);
    return wrap;
  }

  function renderSampleChips(){
    const c = el('sampleChips');
    c.innerHTML = '';
    sampleImageDescriptions.forEach((desc) => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = `+ ${desc}`;
      chip.onclick = () => {
        state.files.push({ name: 'sample-image', desc });
        renderFileList();
      };
      c.appendChild(chip);
    });
  }

  function renderFileList(){
    const list = el('fileList');
    list.innerHTML = '';

    if(state.files.length === 0){
      const empty = document.createElement('div');
      empty.className = 'small';
      empty.textContent = 'No images added.';
      list.appendChild(empty);
      return;
    }

    state.files.forEach((f, idx) => {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="file-head">
          <div class="file-name">${f.name || 'image'}</div>
          <button class="btn-mini" data-idx="${idx}">Remove</button>
        </div>
        <div style="height:8px;"></div>
        <input type="text" placeholder="Text description that will be sent" value="${escapeHtml(f.desc || '')}" data-desc-idx="${idx}" />
      `;
      item.querySelector('button').onclick = () => {
        state.files.splice(idx, 1);
        renderFileList();
      };
      item.querySelector('input').oninput = (e) => {
        state.files[idx].desc = e.target.value;
      };
      list.appendChild(item);
    });
  }

  function escapeHtml(str){
    return (str || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  async function loadScadaOptions(){
    const resp = await fetch('/api/scada/options');
    if(!resp.ok) throw new Error('Failed to load SCADA options');
    const data = await resp.json();
    state.scadaOptions = data.options || [];

    const sel = el('scadaSelect');
    sel.innerHTML = '';
    state.scadaOptions.forEach((o, idx) => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });

    sel.onchange = () => renderScadaPreview();
    renderScadaPreview();
  }

  function renderScadaPreview(){
    const sel = el('scadaSelect');
    const id = sel.value;
    const o = state.scadaOptions.find(x => x.id === id);
    if(!o){ el('scadaPreview').textContent = ''; return; }
    const s = o.preview || '';
    el('scadaPreview').textContent = s;
  }

  function renderResultsTable(items){
    state.lastResults = items || [];
    const showN = Math.max(3, Math.min(30, parseInt(el('showRows').value || '10', 10)));

    const body = el('resultsBody');
    body.innerHTML = '';

    (state.lastResults.slice(0, showN)).forEach((it, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${(it.score ?? 0).toFixed ? it.score.toFixed(3) : it.score}</td>
        <td class="mono">${escapeHtml(it.source)}</td>
        <td class="mono">${it.page}-${it.page_end}</td>
        <td>${escapeHtml(it.section || '')}</td>
        <td class="snippet">${escapeHtml(it.snippet || '')}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function run(){
    showWarn('');
    setStatus('running');
    el('runBtn').disabled = true;

    const freeText = el('freeText').value || '';
    const mechanicNotes = el('mechanicNotes').value || '';
    const scadaId = el('scadaSelect').value;
    const topK = Math.max(3, Math.min(30, parseInt(el('topK').value || '10', 10)));

    const imageDescriptions = state.files
      .map(f => (f.desc || '').trim())
      .filter(Boolean);

    const userSummary = [
      freeText && `Free text: ${freeText}`,
      mechanicNotes && `Mechanic notes: ${mechanicNotes}`,
      scadaId && `SCADA: ${scadaId}`,
      imageDescriptions.length && `Images: ${imageDescriptions.join(' | ')}`,
    ].filter(Boolean).join('\n');

    addChatMessage('user', 'Incident input', escapeHtml(userSummary || '(empty)'));

    const placeholder = addChatMessage('assistant', 'Recommendation', '<span class="spinner"></span> thinking...');

    try {
      const resp = await fetch('/api/run', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          scada_id: scadaId,
          free_text: freeText,
          mechanic_notes: mechanicNotes,
          image_descriptions: imageDescriptions,
          top_k: topK,
        })
      });

      const data = await resp.json();
      if(!resp.ok){
        throw new Error(data?.detail || 'Request failed');
      }

      const rec = data.recommendation_markdown || '(no recommendation)';
      placeholder.querySelector('.m-b').textContent = rec;

      // Optional: show built query pack in the model pill
      if(data.query_pack && data.query_pack.query){
        el('modelPill').textContent = `query ready`;
      }

      renderResultsTable(data.retrieved || []);

    } catch (e) {
      placeholder.querySelector('.m-b').textContent = `Error: ${e.message}`;
      showWarn(e.message);
    } finally {
      setStatus('idle');
      el('runBtn').disabled = false;
    }
  }

  function setupDropZone(){
    const drop = el('drop');
    const input = el('fileInput');

    drop.onclick = () => input.click();

    function handleFiles(fileList){
      [...fileList].forEach(f => {
        state.files.push({ name: f.name, desc: '' });
      });
      renderFileList();
    }

    drop.addEventListener('dragover', (e) => {
      e.preventDefault();
      drop.classList.add('drag');
    });
    drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.classList.remove('drag');
      if(e.dataTransfer?.files) handleFiles(e.dataTransfer.files);
    });

    input.addEventListener('change', (e) => {
      if(e.target.files) handleFiles(e.target.files);
      input.value = '';
    });
  }

  function setupControls(){
    el('runBtn').onclick = run;
    el('showRows').oninput = () => renderResultsTable(state.lastResults);

    const range = el('rangeRows');
    range.oninput = () => {
      el('rangeLabel').textContent = range.value;
      el('showRows').value = range.value;
      renderResultsTable(state.lastResults);
    };
  }

  (async function init(){
    renderSampleChips();
    renderFileList();
    setupDropZone();
    setupControls();
    try {
      await loadScadaOptions();
    } catch (e) {
      showWarn(e.message);
    }
  })();
</script>
</body>
</html>
