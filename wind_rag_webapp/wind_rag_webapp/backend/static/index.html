<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wind Turbine Inspection Assistant</title>
  <style>
    :root {
      --bg: #0c131c;
      --panel: #0f1a26;
      --panel-2: #122031;
      --text: #e7eef6;
      --muted: #9fb0c3;
      --border: #233a4f;
      --accent: #22c55e;
      --accent-2: #38bdf8;
      --danger: #ef4444;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: "Trebuchet MS", "Segoe UI", sans-serif;
      --display: "Trebuchet MS", "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--sans);
      background:
        radial-gradient(900px 420px at 10% -10%, rgba(56,189,248,.18) 0%, transparent 60%),
        radial-gradient(1000px 520px at 90% 0%, rgba(34,197,94,.12) 0%, transparent 65%),
        linear-gradient(180deg, #0c1420 0%, var(--bg) 55%);
      color: var(--text);
    }
    a { color: inherit; }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .logo {
      width: 58px;
      height: 58px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding: 6px;
    }
    .logo.is-spinning {
      animation: logo-spin 1.2s ease-in-out;
    }
    .title h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
      font-family: var(--display);
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }
    .pill {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(320px, 420px) 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .card-h {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.12);
    }
    .card .card-h h2 {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .card .card-b { padding: 16px; }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 6px;
    }
    textarea, select, input[type="text"], input[type="number"], input[type="datetime-local"] {
      width: 100%;
      color: var(--text);
      background: rgba(0,0,0,.20);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    textarea { min-height: 86px; resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .drop {
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.14);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: .15s ease;
      user-select: none;
    }
    .drop.drag {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(34,197,94,.18);
    }
    .drop b { color: var(--text); }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .chip:hover { border-color: rgba(255,255,255,.35); }

    .file-list { margin-top: 10px; display: grid; gap: 10px; }
    .file-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,.18);
    }
    .file-item.is-ignored {
      opacity: .5;
    }
    .file-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .file-name { font-family: var(--mono); font-size: 12px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn-mini {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    .btn-mini:hover { border-color: rgba(255,255,255,.35); }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
    }
    .btn {
      background: var(--accent);
      border: 0;
      color: #062015;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
    }
    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-row .btn {
      width: auto;
    }

    /* Chat area */
    .chat {
      min-height: 560px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(0,0,0,.16);
    }
    .msg .m-h {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.10);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    .msg .m-b {
      padding: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .mono { font-family: var(--mono); }
    .chat-image {
      display: grid;
      gap: 8px;
    }
    .chat-image img {
      width: 100%;
      max-height: 360px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1118;
    }
    .chat-image .caption {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
    }

    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: var(--accent);
      border-radius: 999px;
      animation: spin 1s linear infinite;
      vertical-align: -2px;
    }
    .processing-hint {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(34,197,94,.10);
      color: var(--text);
      font-size: 13px;
    }
    body.is-running .processing-hint {
      display: flex;
    }
    .inspect-inline {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .inspect-status {
      font-size: 12px;
      color: var(--accent);
      border: 1px solid rgba(34,197,94,.35);
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
    }
    .image-review {
      display: grid;
      gap: 12px;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .image-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      overflow: hidden;
    }
    .image-card.is-ignored {
      opacity: .5;
    }
    .image-preview {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
      background: #0b1118;
    }
    .image-meta {
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .image-name {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
    }
    .image-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes logo-spin { to { transform: rotate(360deg); } }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th { font-size: 12px; color: var(--muted); font-weight: 600; background: rgba(0,0,0,.10); }
    td { font-size: 13px; }
    .snippet { color: var(--muted); font-size: 12px; }
    .warn { color: var(--danger); font-size: 12px; }

    .table-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 0;
    }
    .table-controls .left { display: flex; gap: 10px; align-items: center; }
    .range { width: 220px; }

    /* Time range buttons */
    .time-range-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .btn-secondary {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 500;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: .15s ease;
    }
    .btn-secondary:hover {
      border-color: rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
    }
    .btn-secondary:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .btn-secondary.active {
      border-color: var(--accent);
      background: rgba(34,197,94,.15);
    }

    /* Filter section */
    .filter-section {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(0,0,0,.12);
      margin-bottom: 10px;
    }
    .filter-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .filter-row.full {
      grid-template-columns: 1fr;
    }
    .filter-group label {
      margin: 0 0 4px;
    }
    .tag-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .tag-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .tag-checkbox input {
      width: auto;
      margin: 0;
    }

    /* Class legend */
    details.legend {
      margin-top: 10px;
      font-size: 12px;
    }
    details.legend summary {
      cursor: pointer;
      color: var(--muted);
      user-select: none;
    }
    details.legend summary:hover {
      color: var(--text);
    }
    .legend-table {
      margin-top: 8px;
      width: 100%;
      border-collapse: collapse;
    }
    .legend-table td {
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    .legend-table td:first-child {
      font-family: var(--mono);
      color: var(--accent-2);
      white-space: nowrap;
    }

    /* SCADA toggle */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.15);
      border-radius: 24px;
      transition: .2s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: var(--text);
      border-radius: 50%;
      transition: .2s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--accent);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    .scada-section {
      transition: max-height .3s ease, opacity .2s ease;
      max-height: 1200px;
      overflow: hidden;
    }
    .scada-section.collapsed {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }

    /* SCADA card list */
    .scada-card-list {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
    }
    .scada-card-item {
      display: grid;
      grid-template-columns: 24px 140px 1fr;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .1s;
      font-size: 12px;
    }
    .scada-card-item:last-child {
      border-bottom: none;
    }
    .scada-card-item:hover {
      background: rgba(255,255,255,.04);
    }
    .scada-card-item.selected {
      background: rgba(34,197,94,.12);
      border-color: var(--accent);
    }
    .scada-card-item input[type="radio"] {
      width: 16px;
      height: 16px;
      margin: 0;
      accent-color: var(--accent);
    }
    .scada-card-id {
      font-family: var(--mono);
      color: var(--text);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .scada-card-class {
      font-family: var(--mono);
      color: var(--accent-2);
      font-size: 11px;
    }
    .scada-card-status {
      color: var(--muted);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 12px;
      border-left: 1px solid var(--border);
    }
    .scada-card-status.anomaly {
      color: var(--danger);
    }
    .scada-card-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-start;
      min-width: 100px;
    }
    .scada-card-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(56,189,248,.15);
      color: var(--accent-2);
      white-space: nowrap;
    }
    .scada-card-empty {
      padding: 16px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }
    .scada-list-header {
      display: grid;
      grid-template-columns: 24px 140px 1fr;
      gap: 8px;
      padding: 6px 12px;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.15);
      position: sticky;
      top: 0;
    }
    .scada-list-header span:last-child {
      padding-left: 12px;
      border-left: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">
        <span class="logo-wrap">
          <img class="logo is-spinning" src="/static/Windradsvg.svg" alt="Wind turbine logo" />
        </span>
        <div>
          <h1>Wind Turbine Inspection Assistant</h1>
          <div class="subtitle">Manual RAG with SCADA context (vision input WIP)</div>
        </div>
      </div>
      <span class="pill">MVP</span>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <div class="card-h"><h2>Inputs</h2><span class="pill" id="statusPill">idle</span></div>
        <div class="card-b">
          <label>Mechanic notes (optional)</label>
          <textarea id="mechanicNotes" placeholder="e.g., customer report, recent maintenance, observed behavior..."></textarea>

          <label>Images (drag & drop). Images are used for automatic descriptions.</label>
          <div id="drop" class="drop">
            <b>Drop images here</b><div class="small">or click to select.</div>
            <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
          </div>
          <div class="file-list" id="fileList"></div>

          <!-- SCADA Toggle -->
          <div class="toggle-row">
            <label class="toggle-switch">
              <input type="checkbox" id="scadaToggle" />
              <span class="toggle-slider"></span>
            </label>
            <span>Include SCADA data</span>
          </div>

          <div id="scadaSection" class="scada-section collapsed">
          <!-- SCADA Time Range Section (simulated - no functionality) -->
          <label>SCADA time range (simulated)</label>
          <div class="time-range-section">
            <button type="button" class="btn-secondary" id="btnLast6h" disabled title="Simulated: No live SCADA data available">
              Last 6 Hours
            </button>
            <button type="button" class="btn-secondary" id="btnCustomTime" disabled title="Simulated: No live SCADA data available">
              Custom Time
            </button>
            <input type="datetime-local" id="customTimeInput" disabled style="flex: 1; min-width: 180px;" />
          </div>
          <div class="small" style="margin-bottom: 12px; color: var(--muted);">
            ⚠️ Above buttons simulate real-world usage. For testing, select from available SCADA cards below.
          </div>

          <!-- SCADA Card Selection with Filters -->
          <label>Select SCADA card for testing</label>
          <div class="filter-section">
            <div class="filter-group">
              <label>Filter by tags</label>
              <div class="tag-checkboxes" id="tagCheckboxes">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <label>Available SCADA cards (<span id="cardCount">0</span> matching)</label>
          <div class="scada-card-list" id="scadaCardList">
            <div class="scada-list-header">
              <span></span>
              <span>ID</span>
              <span>Tags</span>
            </div>
            <!-- Cards populated by JS -->
          </div>
          <input type="hidden" id="scadaSelect" />
          <div class="small" id="scadaPreview" style="margin-top:6px;"></div>
          </div><!-- end scadaSection -->

          <div class="row">
            <div>
              <label>Retrieve top K</label>
              <input id="topK" type="number" min="3" max="30" value="10" />
              <div class="small">Returned by backend</div>
            </div>
            <div>
              <label>Show rows</label>
              <input id="showRows" type="number" min="3" max="30" value="10" />
              <div class="small">Client-side filter</div>
            </div>
          </div>

          <div class="actions">
            <button id="runBtn" class="btn">Run</button>
          </div>
          <div class="small" style="margin-top:10px;">
            Tip: Retrieval is biased toward procedures, checklists, and safety content.
          </div>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="card">
      <div class="card-h"><h2>Conversation</h2><span class="pill" id="modelPill">model: auto</span></div>
      <div class="card-b">
        <div class="processing-hint" id="processingHint" aria-live="polite">
          <span class="spinner"></span>
          Processing request…
        </div>
        <div class="chat" id="chat"></div>

          <div style="height: 14px;"></div>

          <div class="card" style="box-shadow:none;">
            <div class="card-h">
              <h2>Top retrieved manual chunks</h2>
              <div class="table-controls">
                <div class="left">
                  <span class="small">Show</span>
                  <input class="range" id="rangeRows" type="range" min="3" max="30" value="10" />
                  <span class="pill" id="rangeLabel">10</span>
                </div>
              </div>
            </div>
            <div class="card-b" style="padding:0;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Score</th>
                    <th>Source</th>
                    <th>Pages</th>
                    <th>Section</th>
                    <th>Snippet</th>
                  </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  const state = {
    files: [], // {name, desc, data_url, use}
    scadaOptions: [],
    allScadaCards: [],  // All loaded SCADA cards
    filteredScadaCards: [],  // Cards after filtering
    allTags: [],  // All available tags
    allClasses: [],  // All available classes
    lastResults: [],
    reviewMessage: null,
  };

  function el(id){ return document.getElementById(id); }


  function setStatus(text){
    el('statusPill').textContent = text;
  }

  function setRunning(isRunning){
    document.body.classList.toggle("is-running", !!isRunning);
    document.body.setAttribute("aria-busy", isRunning ? "true" : "false");
  }

  function showWarn(msg){
    const box = el('warnBox');
    if (!box) {
      return;
    }
    box.style.display = msg ? 'block' : 'none';
    box.textContent = msg || '';
  }

  function addChatMessage(role, title, body){
    const chat = el('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg';
    wrap.innerHTML = `
      <div class="m-h"><span>${title}</span><span class="pill">${role}</span></div>
      <div class="m-b" id="msg_${Date.now()}">${body}</div>
    `;
    chat.prepend(wrap);
    return wrap;
  }

  function addChatImage(item){
    if (!item || !item.data_url) {
      return;
    }
    const body = `
      <div class="chat-image">
        <img src="${item.data_url}" alt="${escapeHtml(item.name || "uploaded image")}" />
        <div class="caption">${escapeHtml(item.name || "uploaded image")}</div>
        <div class="caption image-desc" data-image-id="${escapeHtml(item.id)}" style="margin-top:6px;">
          ${escapeHtml(item.desc || "")}
        </div>
        <div class="inspect-inline">
          <button class="btn-mini inspect-btn" data-image-id="${escapeHtml(item.id)}">Inspect images</button>
          <span class="inspect-status">Accepted</span>
        </div>
      </div>
    `;
    const wrap = addChatMessage("user", "Uploaded image", body);
    const btn = wrap.querySelector(".inspect-btn");
    if (btn) {
      btn.onclick = () => inspectSingleImage(item.id);
    }
    updateInspectStatus();
  }

  function renderFileList(){
    const list = el('fileList');
    if (!list) {
      return;
    }
    list.innerHTML = '';

    if(state.files.length === 0){
      const empty = document.createElement('div');
      empty.className = 'small';
      empty.textContent = 'No images added.';
      list.appendChild(empty);
      return;
    }

    state.files.forEach((f, idx) => {
      const item = document.createElement('div');
      item.className = `file-item${f.use === false ? ' is-ignored' : ''}`;
      item.innerHTML = `
        <div class="file-head">
          <div class="file-name">${f.name || 'image'}</div>
          <button class="btn-mini" data-idx="${idx}">Remove</button>
        </div>
        <div style="height:8px;"></div>
        <input type="text" placeholder="Text description that will be sent" value="${escapeHtml(f.desc || '')}" data-desc-idx="${idx}" />
      `;
      item.querySelector('button').onclick = () => {
        state.files.splice(idx, 1);
        state.reviewTargetId = null;
        renderFileList();
        updateInspectStatus();
      };
      item.querySelector('input').oninput = (e) => {
        state.files[idx].desc = e.target.value;
      };
      if (f.use === false) {
        item.querySelector('input').disabled = true;
      }
      list.appendChild(item);
    });
  }

  function renderImageReview(){
    if (state.reviewMessage) {
      state.reviewMessage.remove();
      state.reviewMessage = null;
    }

    const wrap = addChatMessage("assistant", "Image Review", "");
    state.reviewMessage = wrap;
    const body = wrap.querySelector(".m-b");
    if (!body) {
      return;
    }
    body.innerHTML = "";

    const review = document.createElement("div");
    review.className = "image-review";

    const grid = document.createElement("div");
    grid.className = "image-grid";

    state.files.forEach((f, idx) => {
      if (!f.data_url) {
        return;
      }
      if (state.reviewTargetId && f.id !== state.reviewTargetId) {
        return;
      }
      if (typeof f.use === "undefined") {
        f.use = true;
      }

      const card = document.createElement("div");
      card.className = `image-card${f.use === false ? " is-ignored" : ""}`;

      const img = document.createElement("img");
      img.className = "image-preview";
      img.src = f.data_url;
      img.alt = f.name || "uploaded image";

      const meta = document.createElement("div");
      meta.className = "image-meta";

      const name = document.createElement("div");
      name.className = "image-name";
      name.textContent = f.name || "uploaded image";

      const label = document.createElement("label");
      label.textContent = "Description";

      const textarea = document.createElement("textarea");
      textarea.value = f.desc || "";
      textarea.disabled = f.use === false;
      textarea.oninput = (e) => {
        state.files[idx].desc = e.target.value;
      };

      const actions = document.createElement("div");
      actions.className = "image-actions";

      const toggle = document.createElement("button");
      toggle.className = "btn-mini";
      toggle.textContent = f.use === false ? "Use" : "Ignore";
      toggle.onclick = () => {
        f.use = f.use === false ? true : false;
        card.classList.toggle("is-ignored", f.use === false);
        toggle.textContent = f.use === false ? "Use" : "Ignore";
        textarea.disabled = f.use === false;
        renderFileList();
      };

      actions.appendChild(toggle);
      meta.appendChild(name);
      meta.appendChild(label);
      meta.appendChild(textarea);
      meta.appendChild(actions);
      card.appendChild(img);
      card.appendChild(meta);
      grid.appendChild(card);
    });

    review.appendChild(grid);

    const actionRow = document.createElement("div");
    actionRow.className = "btn-row";

    const confirmBtn = document.createElement("button");
    confirmBtn.className = "btn";
    confirmBtn.textContent = "Accept image";
    confirmBtn.onclick = () => {
      if (state.reviewMessage) {
        state.reviewMessage.remove();
        state.reviewMessage = null;
      }
      const target = state.files.find((f) => f.id === state.reviewTargetId);
      if (target) {
        target.approved = true;
        target.inspected = true;
      }
      showWarn("");
      setStatus("idle");
      updateInspectStatus();
    };

    const rejectBtn = document.createElement("button");
    rejectBtn.className = "btn-mini";
    rejectBtn.textContent = "Reject Images";
    rejectBtn.onclick = () => {
      const target = state.files.find((f) => f.id === state.reviewTargetId);
      if (target) {
        target.use = false;
        target.desc = "";
        target.approved = false;
        target.inspected = true;
      }
      renderFileList();
      if (state.reviewMessage) {
        state.reviewMessage.remove();
        state.reviewMessage = null;
      }
      showWarn("");
      setStatus("idle");
      updateInspectStatus();
    };

    actionRow.appendChild(confirmBtn);
    actionRow.appendChild(rejectBtn);
    review.appendChild(actionRow);
    body.appendChild(review);
    updateInspectStatus();
  }

  function escapeHtml(str){
    return (str || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function renderMarkdownSimple(text){
    const lines = (text || "").split(/\r?\n/);
    let html = "";
    let inOl = false;
    let inUl = false;

    const closeLists = () => {
      if (inOl) {
        html += "</ol>";
        inOl = false;
      }
      if (inUl) {
        html += "</ul>";
        inUl = false;
      }
    };

    lines.forEach((rawLine) => {
      const line = rawLine.trim();
      if (!line) {
        closeLists();
        html += "<br>";
        return;
      }

      if (line.startsWith("### ")) {
        closeLists();
        html += `<h3>${escapeHtml(line.slice(4))}</h3>`;
        return;
      }
      if (line.startsWith("#### ")) {
        closeLists();
        html += `<h4>${escapeHtml(line.slice(5))}</h4>`;
        return;
      }

      const olMatch = line.match(/^(\d+)\.\s+(.*)$/);
      if (olMatch) {
        if (!inOl) {
          closeLists();
          html += "<ol>";
          inOl = true;
        }
        const itemText = escapeHtml(olMatch[2]).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        html += `<li>${itemText}</li>`;
        return;
      }

      const ulMatch = line.match(/^-+\s+(.*)$/);
      if (ulMatch) {
        if (!inUl) {
          closeLists();
          html += "<ul>";
          inUl = true;
        }
        const itemText = escapeHtml(ulMatch[1]).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        html += `<li>${itemText}</li>`;
        return;
      }

      closeLists();
      const withBold = escapeHtml(line).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      html += `<p>${withBold}</p>`;
    });

    closeLists();
    return html;
  }

  function normalizeDescription(text){
    const raw = (text || "").trim();
    if (!raw) {
      return "";
    }
    if (raw.startsWith("{") && raw.endsWith("}")) {
      try {
        const obj = JSON.parse(raw);
        if (obj && typeof obj.description === "string") {
          return obj.description.trim();
        }
      } catch (e) {
        return raw;
      }
    }
    return raw;
  }

  async function loadScadaOptions(){
    // Load all SCADA cards from new endpoint
    const resp = await fetch('/api/scada-cards/all');
    if(!resp.ok) throw new Error('Failed to load SCADA cards');
    const data = await resp.json();
    
    state.allScadaCards = data.cards || [];
    state.allTags = data.all_tags || [];
    state.allClasses = data.all_classes || [];
    
    // Populate tag checkboxes
    const tagContainer = el('tagCheckboxes');
    tagContainer.innerHTML = '';
    if (state.allTags.length === 0) {
      tagContainer.innerHTML = '<span class="small">No tags available</span>';
    } else {
      state.allTags.forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag-checkbox';
        label.innerHTML = `<input type="checkbox" value="${escapeHtml(tag)}" /> ${escapeHtml(tag)}`;
        label.querySelector('input').onchange = applyFilters;
        tagContainer.appendChild(label);
      });
    }
    
    // Initial filter application
    applyFilters();
  }

  function getSelectedTags() {
    const checkboxes = el('tagCheckboxes').querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  function applyFilters() {
    const selectedTags = getSelectedTags();
    
    // Apply tags filtering
    state.filteredScadaCards = state.allScadaCards.filter(card => {
      // Tags filter (AND: card must have ALL selected tags)
      if (selectedTags.length > 0) {
        const cardTags = card.tags || [];
        if (!selectedTags.every(tag => cardTags.includes(tag))) {
          return false;
        }
      }
      
      return true;
    });
    
    // Update card count
    el('cardCount').textContent = state.filteredScadaCards.length;
    
    // Update dropdown
    renderScadaDropdown();
  }

  function renderScadaDropdown() {
    const list = el('scadaCardList');
    const hiddenInput = el('scadaSelect');
    
    // Keep the header, remove other children
    const header = list.querySelector('.scada-list-header');
    list.innerHTML = '';
    if (header) list.appendChild(header);
    
    if (state.filteredScadaCards.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'scada-card-empty';
      empty.textContent = 'No matching cards';
      list.appendChild(empty);
      hiddenInput.value = '';
      el('scadaPreview').textContent = '';
      return;
    }
    
    state.filteredScadaCards.forEach((card, idx) => {
      const item = document.createElement('div');
      item.className = 'scada-card-item' + (idx === 0 ? ' selected' : '');
      item.dataset.cardId = card.id;
      
      // Radio button
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'scadaCard';
      radio.value = card.id;
      radio.checked = idx === 0;
      
      // ID - show full ID
      const idSpan = document.createElement('span');
      idSpan.className = 'scada-card-id';
      idSpan.textContent = card.id;
      idSpan.title = card.id;
      
      // Tags
      const tagsDiv = document.createElement('div');
      tagsDiv.className = 'scada-card-tags';
      (card.tags || []).forEach(tag => {
        const tagSpan = document.createElement('span');
        tagSpan.className = 'scada-card-tag';
        tagSpan.textContent = tag;
        tagsDiv.appendChild(tagSpan);
      });
      
      item.appendChild(radio);
      item.appendChild(idSpan);
      item.appendChild(tagsDiv);
      
      // Click handler
      item.onclick = () => {
        list.querySelectorAll('.scada-card-item').forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');
        radio.checked = true;
        hiddenInput.value = card.id;
        renderScadaPreview();
      };
      
      list.appendChild(item);
    });
    
    // Set initial value
    hiddenInput.value = state.filteredScadaCards[0]?.id || '';
    renderScadaPreview();
  }

  function renderScadaPreview(){
    const sel = el('scadaSelect');
    const id = sel.value;
    const card = state.filteredScadaCards.find(x => x.id === id);
    if(!card){ el('scadaPreview').textContent = ''; return; }
    
    // Show summary from card case if available
    const summary = card.case?.summary || '';
    el('scadaPreview').textContent = summary.substring(0, 200) + (summary.length > 200 ? '...' : '');
  }

  function renderResultsTable(items){
    state.lastResults = items || [];
    const showN = Math.max(3, Math.min(30, parseInt(el('showRows').value || '10', 10)));

    const body = el('resultsBody');
    body.innerHTML = '';

    (state.lastResults.slice(0, showN)).forEach((it, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${(it.score ?? 0).toFixed ? it.score.toFixed(3) : it.score}</td>
        <td class="mono">${escapeHtml(it.source)}</td>
        <td class="mono">${it.page}-${it.page_end}</td>
        <td>${escapeHtml(it.section || '')}</td>
        <td class="snippet">${escapeHtml(it.snippet || '')}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function run(){
    showWarn('');
    setStatus('running');
    setRunning(true);
    el('runBtn').disabled = true;

    const mechanicNotes = el('mechanicNotes').value || '';
    const scadaEnabled = el('scadaToggle').checked;
    const scadaId = scadaEnabled ? el('scadaSelect').value : null;
    const topK = Math.max(3, Math.min(30, parseInt(el('topK').value || '10', 10)));

    const imageDescriptions = state.files
      .filter(f => f.use !== false)
      .map(f => (f.desc || '').trim())
      .filter(Boolean);

    const imageTargets = state.files
      .filter(f => f.use !== false && !!f.data_url);

    const imageFiles = imageTargets
      .map(f => ({ name: f.name || 'image', data_url: f.data_url }));

    let placeholder = null;
    try {
      const pending = imageTargets.filter((f) => !f.approved);
      if (pending.length) {
        throw new Error("Please inspect and accept each image before running.");
      }

      const userSummary = [
        mechanicNotes && `Mechanic notes: ${mechanicNotes}`,
        scadaId && `SCADA: ${scadaId}`,
        imageDescriptions.length && `Images: ${imageDescriptions.join(' | ')}`,
      ].filter(Boolean).join('\n');

      addChatMessage('user', 'Incident input', escapeHtml(userSummary || '(empty)'));

      placeholder = addChatMessage(
        "assistant",
        "Recommendation",
        "<span class=\"spinner\"></span> thinking..."
      );

      // Get SCADA case data from filtered cards (only if enabled)
      const selectedCard = scadaEnabled ? state.filteredScadaCards.find(c => c.id === scadaId) : null;
      const scadaCase = selectedCard?.case || null;

      const resp = await fetch('/api/run', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          scada_id: scadaId,
          scada_case: scadaCase,
          mechanic_notes: mechanicNotes,
          image_descriptions: imageDescriptions,
          top_k: topK,
        })
      });

      const data = await resp.json();
      if(!resp.ok){
        throw new Error(data?.detail || 'Request failed');
      }

      const rec = data.recommendation_markdown || '(no recommendation)';
      placeholder.querySelector('.m-b').innerHTML = renderMarkdownSimple(rec);

      if(data.query_pack && data.query_pack.query){
        el('modelPill').textContent = `query ready`;
      }

      renderResultsTable(data.retrieved || []);

    } catch (e) {
      const msg = `Error: ${e.message}`;
      if (placeholder) {
        placeholder.querySelector('.m-b').textContent = msg;
      } else {
        addChatMessage('assistant', 'Error', escapeHtml(msg));
      }
      showWarn(e.message);
    } finally {
      setStatus(state.awaitingConfirm ? 'confirm' : 'idle');
      setRunning(false);
      el('runBtn').disabled = false;
    }
  }

  async function inspectSingleImage(imageId){
    showWarn('');
    const target = state.files.find((f) => f.id === imageId);
    if (!target || !target.data_url) {
      showWarn("No images to inspect.");
      return;
    }
    const imageFiles = [{ name: target.name || "image", data_url: target.data_url }];

    if (!imageFiles.length) {
      showWarn("No images to inspect.");
      return;
    }

      setStatus("inspecting");
      setRunning(true);
    el("runBtn").disabled = true;
    const clickedBtn = document.querySelector(`.inspect-btn[data-image-id="${CSS.escape(imageId)}"]`);
    if (clickedBtn) {
      clickedBtn.disabled = true;
    }
    const hint = el("processingHint");
    if (hint) {
      hint.innerHTML = "<span class=\"spinner\"></span> Inspecting image…";
    }

    try {
      const resp = await fetch("/api/faulty-describe", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ image_files: imageFiles })
      });
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data?.detail || "Faulty description failed");
      }

      const descs = data.descriptions || [];
      const d = descs[0];
      if (d && d.description) {
        target.desc = normalizeDescription(d.description);
      }
      if (typeof target.use === "undefined") {
        target.use = true;
      }
      target.inspected = true;
      target.approved = false;
      state.reviewTargetId = imageId;
      renderFileList();
      renderImageReview();
      showWarn("Bitte die Bildbeschreibungen pruefen und bestaetigen.");
      setStatus("confirm");
    } catch (e) {
      showWarn(e.message);
      setStatus("idle");
    } finally {
      setRunning(false);
      el("runBtn").disabled = false;
      if (clickedBtn) {
        clickedBtn.disabled = false;
      }
      if (hint) {
        hint.innerHTML = "<span class=\"spinner\"></span> Processing request…";
      }
      updateInspectStatus();
    }
  }

  function updateInspectStatus(){
    document.querySelectorAll(".inspect-btn").forEach((btn) => {
      const imageId = btn.getAttribute("data-image-id");
      const item = state.files.find((f) => f.id === imageId);
      const approved = !!item?.approved;
      btn.textContent = approved ? "Re-inspect image" : "Inspect images";
      btn.disabled = false;
    });
    document.querySelectorAll(".inspect-status").forEach((badge) => {
      const wrap = badge.closest(".chat-image");
      const btn = wrap ? wrap.querySelector(".inspect-btn") : null;
      const imageId = btn ? btn.getAttribute("data-image-id") : null;
      const item = state.files.find((f) => f.id === imageId);
      badge.textContent = item?.approved ? "Accepted" : "Not accepted";
    });
    document.querySelectorAll(".image-desc").forEach((el) => {
      const imageId = el.getAttribute("data-image-id");
      const item = state.files.find((f) => f.id === imageId);
      el.textContent = item?.desc ? item.desc : "";
    });
  }

  function setupDropZone(){
    const drop = el('drop');
    const input = el('fileInput');

    drop.onclick = () => input.click();

    function handleFiles(fileList){
      [...fileList].forEach(f => {
        const item = { id: `${Date.now()}_${Math.random().toString(16).slice(2)}`, name: f.name, desc: '', data_url: '', use: true, inspected: false, approved: false };
        state.files.push(item);
        state.reviewTargetId = null;
        const reader = new FileReader();
        reader.onload = () => {
          item.data_url = reader.result || '';
          renderFileList();
          addChatImage(item);
        };
        reader.readAsDataURL(f);
      });
      renderFileList();
      updateInspectStatus();
    }

    drop.addEventListener('dragover', (e) => {
      e.preventDefault();
      drop.classList.add('drag');
    });
    drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.classList.remove('drag');
      if(e.dataTransfer?.files) handleFiles(e.dataTransfer.files);
    });

    input.addEventListener('change', (e) => {
      if(e.target.files) handleFiles(e.target.files);
      input.value = '';
    });
  }

  function setupControls(){
    el('runBtn').onclick = run;
    el('showRows').oninput = () => renderResultsTable(state.lastResults);

    // SCADA toggle
    el('scadaToggle').onchange = () => {
      const enabled = el('scadaToggle').checked;
      el('scadaSection').classList.toggle('collapsed', !enabled);
    };

    const range = el('rangeRows');
    range.oninput = () => {
      el('rangeLabel').textContent = range.value;
      el('showRows').value = range.value;
      renderResultsTable(state.lastResults);
    };
  }

  (async function init(){
    renderFileList();
    setupDropZone();
    setupControls();
    try {
      await loadScadaOptions();
    } catch (e) {
      showWarn(e.message);
    }
  })();
</script>
</body>
</html>
